<%#
Copyright (c) 2025, Assistant

Permission to use, copy, modify, and/or distribute this software for any purpose with or without
fee is hereby granted, provided that the above copyright notice and this permission notice appear
in all copies.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE
INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE
FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,
ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
-%>

<%+header%>

<h2 name="content"><%:Holiday Configuration%></h2>
<div class="cbi-map-descr">
<%:Configure holiday settings using external API or CSV upload.%>
</div>

<% if message then %>
<div class="alert-message <%= message_type or 'info' %>">
    <% if message_type == 'error' then %>
        <strong><%:Error%>: </strong>
    <% elseif message_type == 'success' then %>
        <strong><%:Success%>: </strong>
    <% end %>
    <%= message %>
</div>
<% end %>

<div class="cbi-section" id="holiday-api-section">
    <h3><%:External Holiday API%></h3>
    <div class="cbi-section-descr">
        <%:Use external API to check for holidays in specific regions. This has the highest priority.%>
    </div>
    <div class="cbi-section-node">
        <form id="api-config-form" method="post" action="<%=luci.dispatcher.build_url("admin", "wifi_schedule", "api")%>" enctype="application/x-www-form-urlencoded">
            <input type="hidden" name="action" value="update_api_config" />
            <input type="hidden" name="token" value="<%=token%>" />
            
            <div class="cbi-value">
                <label class="cbi-value-title" for="holiday_api_url"><%:API URL%>:</label>
                <div class="cbi-value-field">
                    <input type="url" name="holiday_api_url" id="holiday_api_url" value="" class="cbi-input-text" placeholder="https://date.nager.at/api/v3/IsTodayPublicHoliday/{region}?date={date}" />
                    <div class="cbi-value-description"><%:Use {date}, {region}, {country}, {language} as placeholders. Example: https://date.nager.at/api/v3/PublicHoliday/{date}/{region} or https://some-api.com/holidays?date={date}&country={country}&lang={language}%></div>
                </div>
            </div>
            
            <div class="cbi-value">
                <label class="cbi-value-title" for="holiday_api_key"><%:API Key%>:</label>
                <div class="cbi-value-field">
                    <input type="password" name="holiday_api_key" id="holiday_api_key" value="" class="cbi-input-text" />
                    <div class="cbi-value-description"><%:API key if required by the service%></div>
                </div>
            </div>
            
            <div class="cbi-value">
                <label class="cbi-value-title" for="holiday_api_region"><%:Region Code%>:</label>
                <div class="cbi-value-field">
                    <input type="text" name="holiday_api_region" id="holiday_api_region" value="" class="cbi-input-text" placeholder="US, GB, DE, etc." />
                    <div class="cbi-value-description"><%:Region code used by the API (e.g., US, GB, DE)%></div>
                </div>
            </div>
            
            <div class="cbi-value">
                <label class="cbi-value-title" for="holiday_api_country"><%:Country Code%>:</label>
                <div class="cbi-value-field">
                    <input type="text" name="holiday_api_country" id="holiday_api_country" value="" class="cbi-input-text" placeholder="US, GB, DE, etc." />
                    <div class="cbi-value-description"><%:Country code parameter for the API (alternative to region)%></div>
                </div>
            </div>
            
            <div class="cbi-value">
                <label class="cbi-value-title" for="holiday_api_language"><%:Language%>:</label>
                <div class="cbi-value-field">
                    <input type="text" name="holiday_api_language" id="holiday_api_language" value="" class="cbi-input-text" placeholder="en, de, fr, etc." />
                    <div class="cbi-value-description"><%:Language code for localized holiday names (e.g., en, de, fr)%></div>
                </div>
            </div>
            
            <div class="cbi-value">
                <div class="cbi-value-field">
                    <input type="button" class="btn cbi-button cbi-button-apply" value="<%:Save API Configuration%>" onclick="saveApiConfig()" />
                    <input type="button" class="btn cbi-button cbi-button-action" value="<%:Use Default URL%>" onclick="useDefaultUrl()" />
                    <input type="button" class="btn cbi-button cbi-button-action" value="<%:Test API Connection%>" onclick="testApiConnection()" />
                </div>
            </div>
        </form>
    </div>
</div>

<div class="cbi-section" id="csv-upload-section">
    <h3><%:CSV Upload%></h3>
    <div class="cbi-section-descr">
        <%:Upload a CSV file containing specific date schedules. This has higher priority than predefined holidays but lower than API.%>
    </div>
    <div class="cbi-section-node">
        <form method="post" enctype="multipart/form-data" action="<%=luci.dispatcher.build_url("admin", "wifi_schedule", "upload_csv")%>">
            <div class="cbi-value">
                <label class="cbi-value-title" for="csv_file"><%:CSV File%>:</label>
                <div class="cbi-value-field">
                    <input type="file" name="csv_file" id="csv_file" accept=".csv" required />
                </div>
            </div>
            
            <div class="cbi-value">
                <div class="cbi-value-field">
                    <input type="submit" class="btn cbi-button cbi-button-positive" value="<%:Upload and Process%>" />
                </div>
            </div>
        </form>
    </div>
    
    <h4><%:CSV Format Requirements%></h4>
    <ul>
        <li><%:The CSV file should contain two columns: date and action%></li>
        <li><%:Date formats accepted: YYYY-MM-DD, MM/DD/YYYY, DD/MM/YYYY%></li>
        <li><%:Action values: "on"/"enable"/"start" or "off"/"disable"/"stop"%></li>
        <li><%:Example:%>
            <pre class="code">date,action
2025-01-01,disable
2025-01-02,enable
2025-12-25,disable</pre>
        </li>
    </ul>
</div>

<div class="cbi-section" id="priority-info">
    <h3><%:Priority Order%></h3>
    <ol>
        <li><%:External Holiday API (Highest Priority)%></li>
        <li><%:CSV Upload Schedule%></li>
        <li><%:Predefined Holiday Calendar%></li>
        <li><%:Weekend Schedule%></li>
        <li><%:Workday Schedule%></li>
        <li><%:Default Schedule (Lowest Priority)%></li>
    </ol>
</div>

<script type="text/javascript">
//<![CDATA[
    // Load initial values from UCI config
    window.addEventListener('DOMContentLoaded', function() {
        // Fetch current API configuration
        fetch('<%=luci.dispatcher.build_url("admin", "wifi_schedule", "api")%>?action=get_current_config', {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            if (data.holiday_api_url) {
                document.getElementById('holiday_api_url').value = data.holiday_api_url;
            }
            if (data.holiday_api_region) {
                document.getElementById('holiday_api_region').value = data.holiday_api_region;
            }
            if (data.holiday_api_country) {
                document.getElementById('holiday_api_country').value = data.holiday_api_country;
            }
            if (data.holiday_api_language) {
                document.getElementById('holiday_api_language').value = data.holiday_api_language;
            }
        })
        .catch(error => {
            console.log('Could not load current config: ' + error);
        });
    });
    
    function saveApiConfig() {
        const formData = new FormData();
        
        formData.append('action', 'update_api_config');
        formData.append('token', '<%=token%>');
        formData.append('holiday_api_url', document.getElementById('holiday_api_url').value);
        formData.append('holiday_api_key', document.getElementById('holiday_api_key').value);
        formData.append('holiday_api_region', document.getElementById('holiday_api_region').value);
        formData.append('holiday_api_country', document.getElementById('holiday_api_country').value);
        formData.append('holiday_api_language', document.getElementById('holiday_api_language').value);
        
        fetch('<%=luci.dispatcher.build_url("admin", "wifi_schedule", "api")%>', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('<%:API configuration saved successfully%>');
            } else {
                alert('<%:Error saving API configuration%>: ' + data.error);
            }
        })
        .catch(error => {
            alert('<%:Error saving API configuration%>: ' + error);
        });
    }
    
    function testApiConnection() {
        const dateInput = prompt('<%:Enter date to test (YYYY-MM-DD format)%>', '<%=os.date("%Y-%m-%d")%>');
        if (!dateInput) return;
        
        // Validate date format
        const datePattern = /^\d{4}-\d{2}-\d{2}$/;
        if (!datePattern.test(dateInput)) {
            alert('<%:Invalid date format. Please use YYYY-MM-DD%>');
            return;
        }
        
        const region = document.getElementById('holiday_api_region').value || 
                      document.querySelector('#region option[selected]').value || 'US';
        const url = document.getElementById('holiday_api_url').value;
        
        if (!url) {
            alert('<%:Please enter an API URL first%>');
            return;
        }
        
        // Show testing message
        const testButton = document.querySelector('input[value="<%:Test API Connection%>"]');
        const originalText = testButton.value;
        testButton.value = '<%:Testing...%>';
        testButton.disabled = true;
        
        // Call the API
        fetch('<%=luci.dispatcher.build_url("admin", "wifi_schedule", "api")%>?action=is_holiday_external&date=' + dateInput + '&region=' + region, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('<%:API test failed%>: ' + data.error);
            } else {
                if (data.is_holiday === true) {
                    const holidayName = data.name || 'Public Holiday';
                    alert('<%:Test result%>: ' + dateInput + ' <%:is a holiday%> (' + holidayName + ')');
                } else if (data.is_holiday === false) {
                    alert('<%:Test result%>: ' + dateInput + ' <%:is NOT a holiday%>');
                } else {
                    alert('<%:Test result%>: <%:Could not determine if%> ' + dateInput + ' <%:is a holiday%> (' + data.error + ')');
                }
            }
        })
        .catch(error => {
            alert('<%:API test failed%>: ' + error);
        })
        .finally(() => {
            // Restore button
            testButton.value = originalText;
            testButton.disabled = false;
        });
    }
    
    function useDefaultUrl() {
        // Set the default API URL for date.nager.at service
        document.getElementById('holiday_api_url').value = 'https://date.nager.at/api/v3/IsTodayPublicHoliday/{region}?date={date}';
        alert('<%:Default URL set. Remember to save the configuration using the Save button.%>');
    }
//]]>
</script>

<style type="text/css">
    .code {
        background-color: #f5f5f5;
        border: 1px solid #ccc;
        padding: 10px;
        font-family: monospace;
        white-space: pre;
        overflow-x: auto;
    }
    
    .cbi-section {
        margin-bottom: 2rem;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fafafa;
    }
    
    .cbi-section h3 {
        margin-top: 0;
        color: #333;
    }
    
    .cbi-section h4 {
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        color: #444;
    }
    
    .cbi-value {
        margin: 1rem 0;
    }
    
    .cbi-value-title {
        font-weight: bold;
        display: inline-block;
        width: 200px;
        vertical-align: top;
    }
    
    .cbi-value-field {
        display: inline-block;
        width: calc(100% - 220px);
    }
    
    .cbi-value-description {
        font-size: 0.85em;
        color: #666;
        margin-top: 0.25rem;
    }
    
    #priority-info ol {
        background-color: white;
        padding: 1rem;
        border-left: 4px solid #007cba;
    }
    
    .alert-message {
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 4px;
    }
    
    .alert-message.error {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .alert-message.success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    
    .alert-message.info {
        color: #0c5460;
        background-color: #d1ecf1;
        border-color: #bee5eb;
    }
</style>

<%+footer%>